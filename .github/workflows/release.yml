name: Release

on:
    release:
        types: [ published ]

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: false

permissions:
    contents: write
    packages: write
    id-token: write

env:
    GO_VERSION: '1.25'

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v6
                with:
                    fetch-depth: 0

            -   name: Set up Go
                uses: actions/setup-go@v6
                with:
                    go-version: ${{ env.GO_VERSION }}
                    cache: true

            -   name: Install Cosign
                uses: sigstore/cosign-installer@v3

            -   name: Install Syft
                uses: anchore/sbom-action/download-syft@v0

            -   name: Save release title
                id: release-title
                env:
                    GH_TOKEN: ${{ secrets.GH_TOKEN }}
                    RELEASE_TAG: ${{ github.event.release.tag_name }}
                run: |
                    TITLE=$(gh release view "$RELEASE_TAG" --json name --jq '.name')
                    echo "title=$TITLE" >> "$GITHUB_OUTPUT"

            -   name: Run GoReleaser
                uses: goreleaser/goreleaser-action@v6
                with:
                    version: latest
                    args: release --clean ${{ github.event.release.prerelease && '--snapshot' || '' }}
                env:
                    GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
                    GORELEASER_CURRENT_TAG: ${{ !github.event.release.prerelease && github.event.release.tag_name || '' }}

            -   name: Restore release title
                env:
                    GH_TOKEN: ${{ secrets.GH_TOKEN }}
                    RELEASE_TAG: ${{ github.event.release.tag_name }}
                    ORIGINAL_TITLE: ${{ steps.release-title.outputs.title }}
                run: |
                    gh release edit "$RELEASE_TAG" --title "$ORIGINAL_TITLE"

            -   name: Generate individual checksums
                run: |
                    while read -r hash name; do
                        echo "$hash  $name" > "dist/${name}.sha256"
                    done < dist/checksums.txt

            -   name: Upload artifacts to release (prerelease)
                if: github.event.release.prerelease
                env:
                    GH_TOKEN: ${{ secrets.GH_TOKEN }}
                    RELEASE_TAG: ${{ github.event.release.tag_name }}
                run: |
                    # Copy binaries with correct names
                    cp dist/assern_linux_amd64_v1/assern dist/assern-linux-amd64
                    cp dist/assern_linux_arm64_v8.0/assern dist/assern-linux-arm64
                    cp dist/assern_darwin_amd64_v1/assern dist/assern-darwin-amd64
                    cp dist/assern_darwin_arm64_v8.0/assern dist/assern-darwin-arm64
                    # Copy signatures and certificates with correct names
                    cp dist/assern_linux_amd64_v1/assern.sig dist/assern-linux-amd64.sig
                    cp dist/assern_linux_amd64_v1/assern.pem dist/assern-linux-amd64.pem
                    cp dist/assern_linux_arm64_v8.0/assern.sig dist/assern-linux-arm64.sig
                    cp dist/assern_linux_arm64_v8.0/assern.pem dist/assern-linux-arm64.pem
                    cp dist/assern_darwin_amd64_v1/assern.sig dist/assern-darwin-amd64.sig
                    cp dist/assern_darwin_amd64_v1/assern.pem dist/assern-darwin-amd64.pem
                    cp dist/assern_darwin_arm64_v8.0/assern.sig dist/assern-darwin-arm64.sig
                    cp dist/assern_darwin_arm64_v8.0/assern.pem dist/assern-darwin-arm64.pem
                    # Upload all artifacts
                    gh release upload "$RELEASE_TAG" \
                        dist/assern-linux-amd64 \
                        dist/assern-linux-arm64 \
                        dist/assern-darwin-amd64 \
                        dist/assern-darwin-arm64 \
                        dist/assern-linux-amd64.sig \
                        dist/assern-linux-amd64.pem \
                        dist/assern-linux-arm64.sig \
                        dist/assern-linux-arm64.pem \
                        dist/assern-darwin-amd64.sig \
                        dist/assern-darwin-amd64.pem \
                        dist/assern-darwin-arm64.sig \
                        dist/assern-darwin-arm64.pem \
                        dist/assern-linux-amd64.sha256 \
                        dist/assern-linux-arm64.sha256 \
                        dist/assern-darwin-amd64.sha256 \
                        dist/assern-darwin-arm64.sha256 \
                        dist/checksums.txt \
                        dist/assern-linux-amd64.sbom.spdx.json \
                        dist/assern-linux-arm64.sbom.spdx.json \
                        dist/assern-darwin-amd64.sbom.spdx.json \
                        dist/assern-darwin-arm64.sbom.spdx.json \
                        --clobber

            -   name: Upload individual checksums (stable)
                if: ${{ !github.event.release.prerelease }}
                env:
                    GH_TOKEN: ${{ secrets.GH_TOKEN }}
                    RELEASE_TAG: ${{ github.event.release.tag_name }}
                run: |
                    gh release upload "$RELEASE_TAG" \
                        dist/assern-linux-amd64.sha256 \
                        dist/assern-linux-arm64.sha256 \
                        dist/assern-darwin-amd64.sha256 \
                        dist/assern-darwin-arm64.sha256 \
                        --clobber
